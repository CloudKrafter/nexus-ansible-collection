---
- name: Get all repositories
  uri:
    url: "{{ nexus_protocol }}://{{ nexus_hostname }}:{{ nexus_port }}/service/rest/v1/repositorySettings"
    method: GET
    validate_certs: false
    status_code: 200
    user: "{{ nexus_admin_username }}"
    password: "{{ nexus_admin_password }}"
    force_basic_auth: true
  register: __nexus_repositories__
  until: __nexus_repositories__.status == 200
  retries: 30
  delay: 10

- name: Filter existing Maven hosted repositories
  set_fact:
    existing_maven_hosted_repos: "{{ __nexus_repositories__.json | selectattr('format', 'equalto', 'maven2') | selectattr('type', 'equalto', 'hosted') | list }}"

- name: Filter existing Maven proxy repositories
  set_fact:
    existing_maven_proxy_repos: "{{ __nexus_repositories__.json | selectattr('format', 'equalto', 'maven2') | selectattr('type', 'equalto', 'proxy') | list }}"

- name: Filter existing Maven group repositories
  set_fact:
    existing_maven_group_repos: "{{ __nexus_repositories__.json | selectattr('format', 'equalto', 'maven2') | selectattr('type', 'equalto', 'group') | list }}"

- name: Determine Maven hosted repositories to create
  set_fact:
    maven_hosted_repos_to_create: "{{ nexus_repos_maven_hosted | rejectattr('name', 'in', existing_maven_hosted_repos | map(attribute='name') | list) | list }}"

- name: Determine Maven hosted repositories to delete
  set_fact:
    maven_hosted_repos_to_delete: "{{ existing_maven_hosted_repos | rejectattr('name', 'in', nexus_repos_maven_hosted | map(attribute='name') | list) | list }}"

- name: show maven_hosted_repos_to_create
  debug:
    var: maven_hosted_repos_to_create

- name: Create configured Maven Hosted repositories using Nexus API
  ansible.builtin.include_tasks: repositories-api.yml
  vars:
    repos: "{{ item | default([]) }}"
    format: maven
    type: hosted
    method: POST
  with_items:
    - "{{ maven_hosted_repos_to_create | default([]) }}"
  when: maven_hosted_repos_to_create | length > 0

- name: Show maven_hosted_repos_to_delete
  debug:
    var: maven_hosted_repos_to_delete

- name: Delete Maven Hosted repositories using Nexus API
  ansible.builtin.include_tasks: repositories-api.yml
  vars:
    repos: "{{ maven_hosted_repos_to_delete | default([]) }}"
    format: maven
    type: hosted
    method: DELETE
  with_items:
    - "{{ maven_hosted_repos_to_delete | default([]) }}"
  when: maven_hosted_repos_to_delete | length > 0
